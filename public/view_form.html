<!DOCTYPE html>
<html lang="en">
<head>
    </head>
<body>
    <div class="page-container">
        <div class="main-content">
            <div class="form-wrapper">
                <h2 id="form-title">Loading...</h2>
                <p id="form-description"></p>
                <form id="dynamic-form"></form>
                <div id="submit-status"></div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // All the code to get elements and build the form is the same
        // ...
        let window.currentFormFields = []; // We will save the fields here

        async function buildForm() {
            // ...
            const formData = doc.data();
            window.currentFormFields = formData.fields; // Save the fields when the form loads
            // ...
        }

        // === FINAL, CORRECTED SUBMISSION LOGIC ===
        formContainer.addEventListener('submit', function(e) {
            e.preventDefault();
            const submitButton = formContainer.querySelector('button[type="submit"]');
            const formData = new FormData(formContainer);
            const submissionData = Object.fromEntries(formData.entries());

            // NEW: We create a complete payload with all the info the server needs
            const payload = {
                spreadsheetId: document.getElementById('spreadsheetIdFromData').value,
                headers: window.currentFormFields, // The array of field objects
                submissionData: submissionData
            };
            
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = 'Submitting data...';

            const endpoint = 'https://casemanagement-server.onrender.com/submit-form';

            fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(result => {
                if (!result.success) { throw new Error(result.error || 'Unknown error'); }
                statusDiv.innerHTML = `<strong>âœ… Success!</strong><br>Your submission has been saved.`;
                formContainer.reset();
            })
            .catch(error => { /* ... error handling ... */ })
            .finally(() => { /* ... */ });
        });

        buildForm();
    });
    </script>
</body>
</html>