<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form | DSWD CM Tool</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --primary-red: #9b1c20; --dark-red: #7e161a; --accent-gold: #ffc107; --light-gray: #f4f7f6; --text-dark: #333333; --text-light: #ffffff; --border-color: #e0e0e0; }
    body { font-family: 'Inter', sans-serif; background-color: var(--light-gray); margin: 0; color: var(--text-dark); }
    .page-container { display: flex; }
    .sidebar { width: 250px; background-color: var(--primary-red); height: 100vh; position: fixed; left: 0; top: 0; transition: transform 0.3s ease; }
    .sidebar .header { padding: 20px; background-color: var(--dark-red); color: var(--text-light); font-size: 20px; font-weight: 700; text-align: center; }
    .sidebar a { display: block; color: var(--text-light); padding: 18px 20px; text-decoration: none; font-weight: 600; border-bottom: 1px solid var(--dark-red); transition: background-color 0.2s; }
    .sidebar a.active { background-color: var(--accent-gold); color: var(--text-dark); }
    .sidebar a:hover:not(.active) { background-color: var(--dark-red); }
    .main-content { flex-grow: 1; margin-left: 250px; padding: 30px; transition: margin-left 0.3s ease; }
    .header-bar { display: none; justify-content: space-between; align-items: center; background: var(--text-light); padding: 10px 20px; border-bottom: 1px solid var(--border-color); }
    .menu-toggle { font-size: 28px; cursor: pointer; background: none; border: none; }
    .form-wrapper { background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    h2 { color: var(--primary-red); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-top: 0; }
    label { display: block; margin-top: 20px; font-weight: 600; font-size: 14px; margin-bottom: 8px; }
    input, select, textarea { width: 100%; padding: 12px; font-size: 16px; border-radius: 6px; border: 1px solid var(--border-color); box-sizing: border-box; background-color: var(--light-gray); font-family: 'Inter', sans-serif; }
    input:focus, select:focus, textarea:focus { border-color: var(--primary-red); outline: none; box-shadow: 0 0 0 2px rgba(155, 28, 32, 0.2); }
    button[type="submit"] { background-color: var(--primary-red); color: #fff; padding: 14px; border: none; border-radius: 6px; margin-top: 30px; cursor: pointer; font-weight: 600; width: 100%; font-size: 16px; transition: background-color 0.2s; }
    button[type="submit"]:disabled { background-color: #ccc; cursor: not-allowed; }
    #submit-status { margin-top: 20px; background-color: #e9f5ff; border-radius: 8px; padding: 15px; white-space: pre-wrap; display: none; font-size: 14px; }
    @media screen and (max-width: 768px) { .sidebar { transform: translateX(-100%); z-index: 1000; } .sidebar.open { transform: translateX(0); } .main-content { margin-left: 0; padding: 20px; } .header-bar { display: flex; } }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="sidebar" id="sidebar">
        <div class="header">DSWD CM Tool</div>
        <a href="index.html">üè† Dashboard</a>
        <a href="forms.html" class="active">üìù Fill Out a Form</a>
        <a href="upload.html">üì§ Upload Files</a>
        <a href="admin.html">‚öôÔ∏è Admin Panel</a>
        <a href="login.html">üîí Login</a>
    </div>

    <div class="main-content">
      <header class="header-bar">
        <span id="mobile-header-title" style="font-weight: 700; color: var(--primary-red);">Loading Form...</span>
        <button class="menu-toggle" id="menu-toggle">‚ò∞</button>
      </header>
      
      <div class="form-wrapper">
        <h2 id="form-title">Loading...</h2>
        <p id="form-description"></p>
        <form id="dynamic-form"></form>
        <div id="submit-status"></div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    document.getElementById('menu-toggle').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('open');
    });

    const firebaseConfig = {
      apiKey: "AIzaSyA-hORXx-5pHAN_JGnoD7Ll4K8XcMC2_fc",
      authDomain: "casemanagement-project.firebaseapp.com",
      projectId: "casemanagement-project"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    const formContainer = document.getElementById('dynamic-form');
    const statusDiv = document.getElementById('submit-status');

    // Data for our smart dropdowns
    const locationData = {
        "IV-A": {
            "Batangas": ["Agoncillo", "Alitagtag", "Balayan", "Balete", "Batangas City", "Bauan", "Calaca", "Calatagan", "Cuenca", "Ibaan", "Laurel", "Lemery", "Lian", "Lipa", "Lobo", "Mabini", "Malvar", "Mataasnakahoy", "Nasugbu", "Padre Garcia", "Rosario", "San Jose", "San Juan", "San Luis", "San Nicolas", "San Pascual", "Santa Teresita", "Santo Tomas", "Taal", "Talisay", "Tanauan", "Taysan", "Tingloy", "Tuy"],
            "Cavite": ["Alfonso", "Amadeo", "Bacoor", "Carmona", "Cavite City", "Dasmari√±as", "General Emilio Aguinaldo", "General Mariano Alvarez", "General Trias", "Imus", "Indang", "Kawit", "Magallanes", "Maragondon", "Mendez", "Naic", "Noveleta", "Rosario", "Silang", "Tagaytay", "Tanza", "Ternate", "Trece Martires"],
            "Laguna": ["Alaminos", "Bay", "Bi√±an", "Cabuyao", "Calamba", "Calauan", "Cavinti", "Famy", "Kalayaan", "Liliw", "Los Ba√±os", "Luisiana", "Lumban", "Mabitac", "Magdalena", "Majayjay", "Nagcarlan", "Paete", "Pagsanjan", "Pakil", "Pangil", "Pila", "Rizal", "San Pablo", "San Pedro", "Santa Cruz", "Santa Maria", "Santa Rosa", "Siniloan", "Victoria"],
            "Quezon": ["Agdangan", "Alabat", "Atimonan", "Buenavista", "Burdeos", "Calauag", "Candelaria", "Catanauan", "Dolores", "General Luna", "General Nakar", "Guinayangan", "Gumaca", "Infanta", "Jomalig", "Lopez", "Lucban", "Lucena", "Macalelon", "Mauban", "Mulanay", "Padre Burgos", "Pagbilao", "Panukulan", "Patnanungan", "Perez", "Pitogo", "Plaridel", "Polillo", "Quezon", "Real", "Sampaloc", "San Andres", "San Antonio", "San Francisco", "San Narciso", "Sariaya", "Tagkawayan", "Tayabas", "Tiaong", "Unisan"],
            "Rizal": ["Angono", "Antipolo", "Baras", "Binangonan", "Cainta", "Cardona", "Jalajala", "Morong", "Pililla", "Rodriguez", "San Mateo", "Tanay", "Taytay", "Teresa"]
        }
    };
    const strandData = {
        "Academic": ["STEM", "ABM", "HUMSS", "GAS"],
        "TVL": ["Agri-Fishery Arts", "Home Economics", "Industrial Arts", "Information and Communications Technology (ICT)", "TVL Maritime"],
        "Arts and Design": ["Arts and Design"],
        "Sports": ["Sports"]
    };

    window.onload = async () => {
      const params = new URLSearchParams(window.location.search);
      const formId = params.get('id');

      if (!formId) {
        document.getElementById('form-title').innerText = "Error: No form specified.";
        return;
      }
      
      try {
        const doc = await db.collection("forms").doc(formId).get();
        if (!doc.exists) {
          document.getElementById('form-title').innerText = "Error: Form not found.";
          return;
        }

        const formData = doc.data();
        
        document.title = `${formData.title} | DSWD CM Tool`;
        document.getElementById('form-title').innerText = formData.title;
        document.getElementById('mobile-header-title').innerText = formData.title;
        document.getElementById('form-description').innerText = formData.description;
        
        formData.fields.forEach(field => {
          const group = document.createElement('div');
          group.className = 'form-group';
          const label = document.createElement('label');
          label.setAttribute('for', field.name);
          label.textContent = field.label;
          group.appendChild(label);

          let input;
          if (field.type === 'select') {
            input = document.createElement('select');
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = `Select ${field.label}...`;
            input.appendChild(defaultOption);
            (field.options || []).forEach(opt => {
              const option = document.createElement('option');
              option.value = opt;
              option.textContent = opt;
              input.appendChild(option);
            });
          } else {
            input = document.createElement('input');
            input.type = field.type;
          }

          input.id = field.name;
          input.name = field.name;
          if (field.required) input.required = true;
          if (field.placeholder) input.placeholder = field.placeholder;
          
          group.appendChild(input);
          formContainer.appendChild(group);
        });

        const submitButton = document.createElement('button');
        submitButton.type = 'submit';
        submitButton.textContent = 'Submit Form';
        formContainer.appendChild(submitButton);

        const regionSelect = formContainer.querySelector('select[name="region"]');
        const provinceSelect = formContainer.querySelector('select[name="province"]');
        const citySelect = formContainer.querySelector('select[name="city"]');
        const trackSelect = formContainer.querySelector('select[name="track"]');
        const strandSelect = formContainer.querySelector('select[name="strand"]');

        if (provinceSelect) provinceSelect.disabled = true;
        if (citySelect) citySelect.disabled = true;
        if (strandSelect) strandSelect.disabled = true;

        if (regionSelect) {
            regionSelect.addEventListener('change', (event) => {
                const selectedRegion = event.target.value;
                const provinces = locationData[selectedRegion] ? Object.keys(locationData[selectedRegion]).sort() : [];
                provinceSelect.innerHTML = '<option value="">Select Province...</option>';
                provinces.forEach(prov => {
                    const option = document.createElement('option');
                    option.value = prov;
                    option.textContent = prov;
                    provinceSelect.appendChild(option);
                });
                provinceSelect.disabled = false;
                citySelect.innerHTML = '<option value="">Select City/Municipality...</option>';
                citySelect.disabled = true;
            });
        }

        if (provinceSelect) {
            provinceSelect.addEventListener('change', (event) => {
                const selectedRegion = regionSelect.value;
                const selectedProvince = event.target.value;
                const cities = locationData[selectedRegion]?.[selectedProvince]?.sort() || [];
                citySelect.innerHTML = '<option value="">Select City/Municipality...</option>';
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
                citySelect.disabled = false;
            });
        }

        if (trackSelect) {
            trackSelect.addEventListener('change', (event) => {
                const selectedTrack = event.target.value;
                const strands = strandData[selectedTrack] || [];
                strandSelect.innerHTML = '<option value="">Select Strand...</option>';
                strands.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s;
                    option.textContent = s;
                    strandSelect.appendChild(option);
                });
                strandSelect.disabled = false;
            });
        }

      } catch (error) {
        console.error("Error rendering form:", error);
        document.getElementById('form-title').innerText = "Error loading form.";
      }
    };

    formContainer.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const submitButton = formContainer.querySelector('button[type="submit"]');
      const formData = new FormData(formContainer);
      const data = Object.fromEntries(formData.entries());

      submitButton.disabled = true;
      submitButton.textContent = 'Submitting...';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = 'Submitting data to server... Please be patient.';

      const endpoint = 'https://casemanagement-server.onrender.com/submit-shs';

      fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => { throw new Error(`Server error: ${response.statusText} - ${text}`) });
        }
        return response.json();
      })
      .then(result => {
        statusDiv.innerHTML = `<strong>‚úÖ Success!</strong><br>Form has been submitted and data saved to the Google Sheet.`;
        submitButton.disabled = false;
        submitButton.textContent = 'Submit Another Form';
        formContainer.reset(); 
      })
      .catch(error => {
        console.error('Error:', error);
        statusDiv.innerHTML = '‚ùå Error submitting form. Please try again.';
        submitButton.disabled = false;
        submitButton.textContent = 'Submit Form';
      });
    });
  </script>
</body>
</html>