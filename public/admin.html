<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | DSWD CM Tool</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* The CSS is the same as the last version */
    :root { --primary-red: #9b1c20; /* ... etc ... */ }
    body { font-family: 'Inter', sans-serif; /* ... */ }
    /* ... */
  </style>
</head>
<body>
  <div class="page-container">
    <div class="sidebar" id="sidebar">
        <a href="admin.html" class="active">⚙️ Admin Panel</a>
    </div>

    <div class="main-content">
        <header class="header-bar">
            </header>
        
        <div class="admin-header">
            <h2>Form Management</h2>
            <a href="edit_form.html" class="btn-create">+ Create New Form</a>
        </div>
        
        <table class="form-list-table">
            <thead>
                <tr>
                    <th>Form Title</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="forms-table-body">
                <tr><td colspan="3">Loading forms from database...</td></tr>
            </tbody>
        </table>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
    // --- Mobile Menu script is the same ---
    document.getElementById('menu-toggle').addEventListener('click', () => { /* ... */ });

    const firebaseConfig = { /* ... Your config ... */ };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.firestore();
    const auth = firebase.auth();

    auth.onAuthStateChanged(user => {
      if (user) {
        loadForms();
      } else {
        window.location.href = 'login.html';
      }
    });

    // --- UPDATED, MORE ROBUST loadForms function ---
    async function loadForms() {
      const tableBody = document.getElementById('forms-table-body');
      tableBody.innerHTML = '<tr><td colspan="3">Loading forms from database...</td></tr>';
      console.log("Attempting to load forms...");
      try {
        const formsSnapshot = await db.collection('forms').get();
        console.log(`Query successful. Found ${formsSnapshot.size} forms.`);

        if (formsSnapshot.empty) {
            tableBody.innerHTML = '<tr><td colspan="3">No forms found. Click "Create New Form" to start.</td></tr>';
            return;
        }

        let allRowsHTML = ''; // Build the HTML in a variable first
        console.log("Starting to build HTML table rows...");
        formsSnapshot.forEach(doc => {
            const formData = doc.data();
            const formId = doc.id;
            console.log(`- Building row for form: ${formData.title}`);
            const row = `
                <tr>
                    <td><strong>${formData.title || 'Untitled Form'}</strong></td>
                    <td>${formData.description || 'No description.'}</td>
                    <td><a href="edit_form.html?id=${formId}" class="btn-edit">Edit</a></td>
                </tr>
            `;
            allRowsHTML += row; // Add the row to our variable
        });

        console.log("Finished building HTML. Updating the table now.");
        tableBody.innerHTML = allRowsHTML; // Update the table only ONCE at the end
        console.log("Table updated successfully!");

      } catch (error) {
        console.error("A critical error occurred while loading forms:", error);
        tableBody.innerHTML = '<tr><td colspan="3">Error loading forms. Check console for details.</td></tr>';
      }
    }
  </script>
</body>
</html>